# Doctrine 2 Service for Laravel 5+

Run all doctrine commands easily using `$ php artisan doctrine <command> <options>`

This service will grab your laravel's configuration (db and cache) and automatically apply it to doctrine2 configurate, no more hassle configuration needed. :)

## Installation

```bash
$ composer require "paolooo/laravel-doctrine":"0.1.*@dev"
```

Open and edit `config/app.php` configuration file, and add the following service provider code to the `$providers` array.

```
        'Paolooo\LaravelDoctrine\LaravelDoctrineServiceProvider',
```

Edit .env file. Add the following doctrine config. For more information,
of doctrine configuration, see, http://doctrine-orm.readthedocs.org/en/latest/reference/advanced-configuration.html.

```
# .env
...

DOCTRINE_PROXY_AUTOGENERATED=false
DOCTRINE_PROXY_NAMESPACE=Acme\Domain\Model\Proxy
DOCTRINE_PROXY_DIR=app/Domain/Model/Proxy
DOCTRINE_MAPPING_DIR=app/Domain/Model

```

This configuration is for testing environment. Edit phpunit.xml file.

```
# phpunit.xml

<?xml version="1.0" encoding="UTF-8"?>
<phpunit ...>
    ....
    <php>
        ...
        <env name="DB_DRIVER" value="pdo_sqlite"/>
        <env name="DB_DATABASE" value="storage/tests/db.sqlite"/>
    </php>
</phpunit>
```


## Running Doctrine Commands

Sample artisan for doctrine.

```bash
$ php artisan doctrine
$ php artisan doctrine help orm:schema-tool:create
$ php artisan doctrine orm:schema-tool:create
$ php artisan doctrine orm:schema-tool:create --dump-sql
$ php artisan doctrine orm:schema-tool:update
$ php artisan doctrine orm:schema-tool:drop
```

## Sample Local Enviroment Config

This is a sample local environment (.env file) configuration.

```
APP_ENV=local
APP_DEBUG=true
...
DB_DRIVER=pdo_mysql
DB_HOST=localhost
DB_DATABASE=pca_dev
DB_USERNAME=root
DB_PASSWORD=
...
CACHE_DRIVER=file
...
DOCTRINE_PROXY_AUTOGENERATED=false
DOCTRINE_PROXY_NAMESPACE=Acme\Domain\Model\Proxy
DOCTRINE_PROXY_DIR=app/Domain/Model/Proxy
DOCTRINE_MAPPING_DIR=app/Domain/Model
```

## Sample Testing Environment Config

This is a sample testing environment (phpunit.xml file) configuration.

```
<?xml version="1.0" encoding="UTF-8"?>
<phpunit ...>
    ....
    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="CACHE_DRIVER" value="array"/>
        ...
        <env name="DB_DRIVER" value="pdo_sqlite"/>
        <env name="DB_DATABASE" value="storage/tests/db.sqlite"/>
    </php>
</phpunit>
```

## Create a ModelTestCase for Unit Testing

Simple extend your testcases to this ModelTestCase.php

```
# tests/ModelTestCase.php

<?php

use Doctrine\ORM\EntityManager;
use Doctrine\ORM\Tools\SchemaTool;

class ModelTestCase extends Illuminate\Foundation\Testing\TestCase
{
    /**
     * @var EntityManager
     */
    protected $entityManager;

    /**
     * Array of \Doctrine\ORM\Mapping\ClassMetadata
     * @var array
     */
    protected $metadata;

    /**
     * Creates the application.
     *
     * @return \Illuminate\Foundation\Application
     */
    public function createApplication()
    {
        $app = require __DIR__.'/../bootstrap/app.php';

        $app->make('Illuminate\Contracts\Console\Kernel')->bootstrap();

        return $app;
    }

    public function setUp()
    {
        parent::setUp();
        $this->initializeDoctrine();
    }

    private function assignClassMetadata()
    {
        foreach($this->classes AS $class) {
            $this->metadata[] = $this->entityManager->getClassMetadata($class);
        }
    }

    /**
     * Initialize Doctrine - this will create database and run schema.
     */
    public function initializeDoctrine()
    {
        $this->entityManager = App::make(EntityManager::class);
        $this->assignClassMetadata();

        $tool = new SchemaTool($this->entityManager);
        $this->dropSchema($tool);
        $tool->createSchema($this->metadata);
    }

    /**
     * Drop database table.
     *
     * @param SchemaTool $tool
     * @return void
     */
    private function dropSchema(SchemaTool $tool)
    {
        $tool->dropSchema($this->metadata);
    }

    public function tearDown()
    {
        $tool = new SchemaTool($this->entityManager);
        $this->dropSchema($tool);
        $this->entityManager->close();
    }

}


# test/RegisterUserTest.php

<?php

class RegisterUserTest extends ModelTestCase
{
    protected $userRepository;

    protected $classes = [
      'App\Namespace\To\UserEntity',
    ];

    public function setUp()
    {
      parent::setUp();
      $this->userRepository = App\Namespace\To\UserDoctrineORMRepository($this->EntityManager);
    }

    ...
}

```

## TODO

- Tests
- Database Migration
